<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Analytics Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .metric-card { transition: transform 0.2s; }
        .metric-card:hover { transform: translateY(-2px); }
        .loading { opacity: 0.6; pointer-events: none; }
        .status-good { color: #198754; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-primary">
        <div class="container">
            <span class="navbar-brand mb-0 h1">üöÄ Log Analytics Dashboard</span>
            <small class="text-light">Real-time log analysis with Scala backend</small>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Controls -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Lines</label>
                        <input type="number" class="form-control" id="lines" value="1000" min="100" max="100000">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Mode</label>
                        <select class="form-select" id="mode">
                            <option value="steady">Steady</option>
                            <option value="burst">Burst</option>
                            <option value="realistic" selected>Realistic</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid gap-2 d-md-flex">
                            <button class="btn btn-success" onclick="generateData()" id="generateBtn">
                                üìä Generate Data
                            </button>
                            <button class="btn btn-primary" onclick="runAnalysis()" id="analyzeBtn">
                                üîç Run Analysis
                            </button>
                            <button class="btn btn-secondary" onclick="runTest()" id="testBtn">
                                üß™ Run Test
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metrics -->
        <div class="row mb-4" id="metricsRow">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h2 class="text-primary" id="total-lines">-</h2>
                        <p class="text-muted mb-0">Total Lines</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h2 class="text-success" id="valid-entries">-</h2>
                        <p class="text-muted mb-0">Valid Entries</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h2 class="text-info" id="success-rate">-%</h2>
                        <p class="text-muted mb-0">Success Rate</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h2 class="text-warning" id="error-rate">-%</h2>
                        <p class="text-muted mb-0">Error Rate</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">üìà Status Code Distribution</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">üîó HTTP Methods</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="methodChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Endpoints -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">üéØ Top Endpoints</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Endpoint</th>
                                <th>Requests</th>
                            </tr>
                        </thead>
                        <tbody id="endpointsBody">
                            <tr>
                                <td colspan="2" class="text-center text-muted">Click "Run Analysis" to load data</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Raw Output -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">üìù Analysis Details</h6>
            </div>
            <div class="card-body">
                <pre id="rawOutput" class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">
Click "Run Analysis" to see detailed results...</pre>
            </div>
        </div>
    </div>

    <script>
        let statusChart, methodChart;
        let isLoading = false;

        function setLoading(loading) {
            isLoading = loading;
            const buttons = ['generateBtn', 'analyzeBtn', 'testBtn'];
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if (loading) {
                    btn.classList.add('loading');
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Loading...';
                } else {
                    btn.classList.remove('loading');
                    const originalText = id.replace('Btn', '');
                    btn.innerHTML = getButtonText(id);
                }
            });
        }

        function getButtonText(btnId) {
            const texts = {
                'generateBtn': 'üìä Generate Data',
                'analyzeBtn': 'üîç Run Analysis',
                'testBtn': 'üß™ Run Test'
            };
            return texts[btnId] || btnId;
        }

        async function generateData() {
            if (isLoading) return;
            setLoading(true);

            const lines = document.getElementById('lines').value;
            const mode = document.getElementById('mode').value;

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lines: parseInt(lines), mode: mode })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    showAlert('success', result.message);
                    // Auto-run analysis after successful generation
                    setTimeout(() => runAnalysis(), 500);
                } else {
                    showAlert('error', result.message);
                }
            } catch (error) {
                showAlert('error', 'Failed to generate data: ' + error.message);
            } finally {
                setLoading(false);
            }
        }

        async function runAnalysis() {
            if (isLoading) return;
            setLoading(true);

            try {
                const response = await fetch('/api/analyze');
                const data = await response.json();
                updateDashboard(data);
                showAlert('success', 'Analysis completed successfully');
            } catch (error) {
                showAlert('error', 'Analysis failed: ' + error.message);
            } finally {
                setLoading(false);
            }
        }

        async function runTest() {
            if (isLoading) return;
            setLoading(true);

            try {
                const response = await fetch('/api/run-test');
                const data = await response.json();
                document.getElementById('rawOutput').textContent = data.output;
                showAlert('success', 'Test completed successfully');
            } catch (error) {
                showAlert('error', 'Test failed: ' + error.message);
            } finally {
                setLoading(false);
            }
        }

        function updateDashboard(data) {
            // Update metrics
            document.getElementById('total-lines').textContent = data.totalLines.toLocaleString();
            document.getElementById('valid-entries').textContent = data.validEntries.toLocaleString();
            document.getElementById('success-rate').textContent = data.parseSuccessRate.toFixed(1) + '%';
            document.getElementById('error-rate').textContent = data.errorRate.toFixed(1) + '%';

            // Update charts
            updateStatusChart(data.statusDistribution);
            updateMethodChart(data.methodCounts);
            updateEndpointsTable(data.topEndpoints);

            // Update raw output
            document.getElementById('rawOutput').textContent = JSON.stringify(data, null, 2);
        }

        function updateStatusChart(statusData) {
            const ctx = document.getElementById('statusChart').getContext('2d');
            const labels = Object.keys(statusData);
            const values = Object.values(statusData);

            if (statusChart) statusChart.destroy();

            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: ['#28a745', '#ffc107', '#dc3545', '#007bff', '#6c757d']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function updateMethodChart(methodData) {
            const ctx = document.getElementById('methodChart').getContext('2d');
            const labels = Object.keys(methodData);
            const values = Object.values(methodData);

            if (methodChart) methodChart.destroy();

            methodChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: '#007bff',
                        borderColor: '#0056b3',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0 }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function updateEndpointsTable(endpoints) {
            const tbody = document.getElementById('endpointsBody');
            tbody.innerHTML = '';

            if (endpoints && endpoints.length > 0) {
                endpoints.forEach(([endpoint, count]) => {
                    const row = tbody.insertRow();
                    row.insertCell(0).textContent = endpoint;
                    row.insertCell(1).textContent = count.toLocaleString();
                });
            } else {
                const row = tbody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 2;
                cell.className = 'text-center text-muted';
                cell.textContent = 'No endpoint data available';
            }
        }

        function showAlert(type, message) {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());

            // Create new alert
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(alertDiv);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-run analysis on page load
            runAnalysis();
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>